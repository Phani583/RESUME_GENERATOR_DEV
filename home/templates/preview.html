{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Resume Preview</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <style>
      body {
        background: #f4f4f4;
        font-family: Arial, sans-serif;
      }
      .resume-wrapper {
        max-width: 800px;
        margin: 30px auto;
        padding: 40px;
        background: #fff;
        color: #000;
      }
      .resume-header {
        text-align: center;
        margin-bottom: 20px;
      }
      .resume-header h1 {
        margin: 0;
        font-size: 28px;
      }
      .contact-line {
        font-size: 14px;
        color: #444;
        margin-top: 6px;
      }
      h2 {
        font-size: 18px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 4px;
        margin-top: 24px;
        margin-bottom: 10px;
      }
      p {
        margin: 6px 0;
        line-height: 1.5;
      }
      ul {
        margin: 6px 0 10px 20px;
        padding: 0;
      }
      li {
        margin: 4px 0;
      }
      .actions {
        margin: 20px auto;
        text-align: center;
      }
      .actions button {
        margin: 0 6px;
        padding: 10px 14px;
      }
      @media print {
        .actions,
        #fontSizeControls {
          display: none !important;
        }
        body {
          background: #fff;
          margin: 0;
          padding: 0;
        }
        @page {
          size: A4;
          margin: 20mm 1mm 18mm 1mm; /* Top Right Bottom Left */
        }

        .preview-page,
        .container {
          page-break-after: always;
          padding: 30mm 25mm 30mm 25mm; /*Adjust here for more margin */
          box-sizing: border-box;
        }

        /* Optional: ensure each card doesn't get split awkwardly */
        .card {
          page-break-inside: avoid;
        }
        /* 6️⃣ Customize first vs remaining pages */
        @page :first {
          margin: 2mm 1mm 16mm 1mm; /* smaller for first page */
        }

        @page {
          margin: 20mm 1mm 18mm 1mm; /* larger for 2nd+ pages */
        }
      }

      .resume-content,
      .resume-content * {
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
        hyphens: auto;
        box-sizing: border-box;
      }
      .resume-content a,
      .resume-content code,
      .resume-content pre {
        word-break: break-all;
        overflow-wrap: anywhere;
      }

      /* --- Resume Header Layout --- */
      .resume-header {
        display: flex;
        justify-content: space-between; /* keep photo fixed right */
        align-items: center;
        margin-bottom: 20px;
      }

      /* If no photo → center everything */
      .resume-header.no-photo {
        justify-content: center;
        text-align: center;
      }

      /* Text block auto-centered */
      .resume-details {
        flex: 1;
        text-align: center; /* center the text block */
      }

      /* Contact line inline */
      .contact-line {
        font-size: 14px;
        color: #444;
        margin-top: 6px;
        display: inline-block;
      }

      /* Profile photo always static (right side) */
      .preview-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-left: 20px;
      }

      .resume-wrapper {
        transition: font-size 0.25s ease-in-out;
        line-height: 1.6;
      }

      #fontSizeControls input[type="range"] {
        width: 120px;
        accent-color: #007bff;
      }

      .preview-content {
        transition: font-size 0.2s ease-in-out;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <!-- Font Size Adjustment Toolbar -->
    <div
      id="fontSizeControls"
      style="
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
        padding: 5px 10px;
        background: #f8f8f8;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      "
    >
      <label for="fontSizeRange" style="font-size: 14px">Font Size:</label>
      <input
        type="range"
        id="fontSizeRange"
        min="12"
        max="24"
        value="16"
        step="1"
      />
      <span id="fontSizeValue" style="font-size: 14px">16px</span>
    </div>
    <div class="actions">
      <button onclick="window.print()">Download PDF</button>
      <button onclick="downloadTxt()">Download TXT</button>
    </div>

    <div class="resume-wrapper" id="resume"></div>

    <script>
      const data = JSON.parse(localStorage.getItem("resumeData") || "{}");
      const resume = document.getElementById("resume");

      function safe(s = "") {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[c])
        );
      }
      function ensureUrl(url) {
        if (!url) return "";
        url = String(url).trim();
        // if already starts with http:// or https:// keep as is
        if (/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) return url;
        // otherwise add https://
        return "https://" + url;
      }
      // ---------- format month-year helper ----------
      function formatMonthYear(val) {
        // Accepts "YYYY-MM" (from <input type="month">) or existing free-text like "Aug 2020"
        if (!val) return "";
        val = String(val).trim();
        // Already "Mon YYYY"?
        if (/^[A-Za-z]{3,}\s+\d{4}$/.test(val)) return val;
        // ISO month format "YYYY-MM"
        const m = val.match(/^(\d{4})-(\d{2})$/);
        if (m) {
          const y = m[1],
            mm = m[2];
          const months = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          const idx = parseInt(mm, 10) - 1;
          if (idx >= 0 && idx < 12) return `${months[idx]} ${y}`;
        }
        // fallback: return raw
        return val;
      }

      function addSection(title, html) {
        if (html && html.trim()) {
          // ensure wrapper exists
          let contentWrapper = document.querySelector(".resume-content");
          if (!contentWrapper) {
            contentWrapper = document.createElement("div");
            contentWrapper.className = "resume-content";
            resume.appendChild(contentWrapper);
          }
          contentWrapper.innerHTML += `<h2>${title}</h2>${html}`;
        }
      }

      // Header
      const pi = data.personalInfo || {};
      const pl = data.publicLinks || {};

      // Build contacts with clickable links
      const contactParts = [];

      // email → mailto
      if (pi.email) {
        contactParts.push(
          `<a href="mailto:${encodeURIComponent(pi.email)}">${safe(
            pi.email
          )}</a>`
        );
      }

      // phone as plain text
      if (pi.phone) contactParts.push(safe(pi.phone));

      // public links
      const labelMap = {
        github: "GitHub",
        linkedin: "LinkedIn",
        portfolio: "Portfolio",
        website: "Website",
      };
      ["github", "linkedin", "portfolio", "website"].forEach((k) => {
        const v = (pl && pl[k]) || "";
        if (v && v.trim()) {
          const href = ensureUrl(v);
          const label = labelMap[k] || k.charAt(0).toUpperCase() + k.slice(1);
          contactParts.push(
            `<a href="${safe(
              href
            )}" target="_blank" rel="noopener noreferrer">${safe(label)}</a>`
          );
        }
      });

      // custom links — use user-entered Link Name instead of "Custom 1"
      if (Array.isArray(pl.custom)) {
        pl.custom.forEach((c) => {
          const name = c && c.name ? c.name.trim() : "";
          const url = c && c.url ? c.url.trim() : "";
          if (name && url) {
            const href = ensureUrl(url);
            contactParts.push(
              `<a href="${safe(
                href
              )}" target="_blank" rel="noopener noreferrer">${safe(name)}</a>`
            );
          }
        });
      }

      let contacts = contactParts.join(" | ");

      resume.innerHTML += `
  <div class="resume-header ${pi.profilePhoto ? "with-photo" : "no-photo"}">
    <div class="resume-details">
      <h1>${safe(pi.fullName || "").toUpperCase()}</h1>
      <div class="contact-line">
        ${contacts}
        ${pi.location ? ` | ${safe(pi.location)}` : ""}
      </div>
    </div>
    ${
      pi.profilePhoto
        ? `<img src="${pi.profilePhoto}" alt="Profile Photo" class="preview-photo" />`
        : ""
    }
  </div>
`;

      // Summary
      if (pi.summary)
        addSection("Professional Summary", `<p>${safe(pi.summary)}</p>`);

      //Education
      // Education
      if (Array.isArray(data.education) && data.education.length) {
        const html = data.education
          .map((e) => {
            const start = formatMonthYear(e.startDate);
            const end = e.current ? "Present" : formatMonthYear(e.endDate);
            const period =
              start || end ? [start, end].filter(Boolean).join(" - ") : "";

            const score =
              e.score && e.scoreType
                ? `${safe(e.scoreType)}: ${safe(e.score)}`
                : "";
            return `
              <p><strong>${safe(e.degree || "")}</strong>, ${safe(
              e.institution || ""
            )} (${safe(period)})</p>
              ${score ? `<p>${score}</p>` : ""}
              ${e.description ? `<p>${safe(e.description)}</p>` : ""}
            `;
          })
          .join("");
        addSection("Education", html);
      }

      // Work Experience
      if (Array.isArray(data.experience) && data.experience.length) {
        const html = data.experience
          .map((e) => {
            const start = formatMonthYear(e.startDate);
            const end = e.current ? "Present" : formatMonthYear(e.endDate);
            const period =
              start || end ? [start, end].filter(Boolean).join(" - ") : "";

            return `
        <p><strong>${safe(e.jobTitle || "")}</strong>, ${safe(
              e.company || ""
            )} (${safe(period)})</p>
        ${
          e.description
            ? `<ul>${e.description
                .split(/[\n•\-]\s*/)
                .filter(Boolean)
                .map((x) => `<li>${safe(x)}</li>`)
                .join("")}</ul>`
            : ""
        }
      `;
          })
          .join("");
        addSection("Work Experience", html);
      }

      // ===== Internships (NEW) =====
      // ===== Internships (UPDATED with Currently Working) =====
      if (Array.isArray(data.internships) && data.internships.length) {
        const html = data.internships
          .map((i) => {
            const start = formatMonthYear(i.startDate);
            const end = i.current ? "Present" : formatMonthYear(i.endDate);
            const period =
              start || end ? [start, end].filter(Boolean).join(" - ") : "";

            return `
        <p><strong>${safe(i.name || "")}</strong>, ${safe(
              i.organization || ""
            )} (${safe(period)})</p>
        ${i.description ? `<p>${safe(i.description)}</p>` : ""}
      `;
          })
          .join("");
        addSection("Internships", html);
      }

      // Projects
      if (Array.isArray(data.projects) && data.projects.length) {
        const html = data.projects
          .map((p) => {
            const start = formatMonthYear(p.startDate);
            const end = formatMonthYear(p.endDate);
            const period =
              start || end ? [start, end].filter(Boolean).join(" - ") : "";

            return `
        <p>
          <strong>${safe(p.name || "")}</strong>
          ${period ? ` (${safe(period)})` : ""}
        </p>
        ${
          p.projectUrl
            ? `<p><a href="${safe(
                ensureUrl(p.projectUrl)
              )}" target="_blank">${safe(p.projectUrl)}</a></p>`
            : ""
        }
        ${
          p.description
            ? `<ul>${p.description
                .split(/[\n•\-]\s*/)
                .filter(Boolean)
                .map((x) => `<li>${safe(x)}</li>`)
                .join("")}</ul>`
            : ""
        }
      `;
          })
          .join("");
        addSection("Projects", html);
      }

      // Certificates
      if (Array.isArray(data.certifications) && data.certifications.length) {
        const html = data.certifications
          .map(
            (c) => `
        <p><strong>${safe(c.name || "")}</strong> - ${safe(
              c.issuer || ""
            )} (${safe(c.date || "")})</p>
            ${
              c.url
                ? `<p><a href="${safe(
                    ensureUrl(c.url)
                  )}" target="_blank">${safe(c.url)}</a></p>`
                : ""
            }
        ${c.description ? `<p>${safe(c.description)}</p>` : ""}
      `
          )
          .join("");
        addSection("Certificates", html);
      }

      // Skills
      if (Array.isArray(data.skills) && data.skills.length) {
        const html = `<ul>${data.skills
          .map(
            (s) =>
              `<li>
          ${safe(s.name || "")}
          ${s.category ? ` - ${safe(s.category)}` : ""}
          ${s.level ? ` (${safe(s.level)})` : ""}
        </li>`
          )
          .join("")}</ul>`;
        addSection("Skills", html);
      }

      // Languages (Native → Expert, with full level display)
      if (Array.isArray(data.languages) && data.languages.length) {
        const html = `<ul>${data.languages
          .map(
            (l) =>
              `<li>${safe(l.name || "")}${
                l.level ? ` (${safe(l.level)})` : ""
              }</li>`
          )
          .join("")}</ul>`;
        addSection("Languages", html);
      }

      // Hobbies
      if (Array.isArray(data.hobbies) && data.hobbies.length) {
        const html = `<ul>${data.hobbies
          .map((h) => `<li>${safe(h.hobby || "")}</li>`)
          .join("")}</ul>`;
        addSection("Hobbies", html);
      }

      // ===== Achievements (OPTION 3 — One bullet, neat alignment) =====
      if (Array.isArray(data.achievements) && data.achievements.length) {
        const html = data.achievements
          .map((a) => {
            const lines = String(a.achievement || a)
              .split(/\n+/)
              .filter(Boolean)
              .map((x) => safe(x));

            if (lines.length === 0) return "";

            // first line with bullet
            let out = `<p style="margin:2px 0;">• ${lines[0]}</p>`;

            // remaining lines — neat small indent
            for (let i = 1; i < lines.length; i++) {
              out += `<p style="padding-left:12px; margin:2px 0;">${lines[i]}</p>`;
            }

            return out;
          })
          .join("");

        addSection("Achievements", html);
      }

      // Additional Info
      if (data.additionalInfo && data.additionalInfo.trim()) {
        const formatted = safe(data.additionalInfo).replace(/\n/g, "<br>");
        addSection("Additional Information", `<p>${formatted}</p>`);
      }

      // Declaration
      if (data.declaration && data.declaration.trim()) {
        const formatted = safe(data.declaration).replace(/\n/g, "<br>");
        addSection("Declaration", `<p>${formatted}</p>`);
      }

      // TXT download
      function downloadTxt() {
        const text = resume.innerText;
        const blob = new Blob([text], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "resume.txt";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      // === Font Size Adjustment ===
      document.addEventListener("input", function (e) {
        if (e.target.id === "fontSizeRange") {
          const size = e.target.value + "px";
          const previewContent = document.querySelector(".resume-wrapper"); // adjust selector if needed
          if (previewContent) {
            previewContent.style.fontSize = size;
            document.getElementById("fontSizeValue").textContent = size;
            localStorage.setItem("previewFontSize", size); // remember choice
          }
        }
      });

      // Apply saved font size when preview opens
      function applySavedFontSize() {
        const saved = localStorage.getItem("previewFontSize");
        const previewContent = document.querySelector(".resume-wrapper");
        const range = document.getElementById("fontSizeRange");
        const value = document.getElementById("fontSizeValue");
        if (saved && previewContent && range && value) {
          previewContent.style.fontSize = saved;
          range.value = parseInt(saved);
          value.textContent = saved;
        }
      }
    </script>
  </body>
</html>
