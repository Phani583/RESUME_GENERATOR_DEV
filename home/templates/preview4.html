{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Preview — Image Sidebar (print-matched, robust html2pdf)</title>
    <style>
      :root {
        --header-bg: #303645;
        --sidebar-bg: #e9e9eb;
        --accent: #2b3344;
        --muted: #6f7478;
        --line: #d9dfe3;
        --white: #ffffff;
      }

      /* Reset / page */
      html,
      body {
        height: 100%;
        margin: 0;
        background: #f4f6f8;
        font-family: "Montserrat", "Helvetica Neue", Arial, sans-serif;
        color: #222;
      }

      /* Wrapper & controls */
      .wrap {
        max-width: 1100px;
        margin: 28px auto;
        padding: 12px;
        box-sizing: border-box;
      }
      .controls {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 14px;
      }
      .controls button {
        background: var(--header-bg);
        color: #fff;
        border: 0;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }

      /* Resume container and header */
      .resume {
        background: var(--white);
        border-radius: 10px;
        overflow: visible; /* allow avatar overlap */
        box-shadow: 0 8px 30px rgba(10, 20, 30, 0.06);
        position: relative;
      }
      .resume-header {
        background: var(--header-bg);
        padding: 36px 24px 44px;
        text-align: center;
        color: var(--white);
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        position: relative;
        z-index: 1;
      }
      .resume-header .name {
        font-size: 46px;
        font-weight: 800;
        letter-spacing: 0.02em;
        margin: 0;
        text-transform: uppercase;
      }
      .resume-header .subtitle {
        margin-top: 8px;
        font-size: 15px;
        opacity: 0.95;
        font-weight: 400;
      }

      /* Body layout (left fixed, right flexible) */
      .resume-body {
        display: flex;
        min-height: 840px;
        box-sizing: border-box;
      }

      /* Left column */
      .left-col {
        width: 230px; /* keep identical for PDF math */
        background: var(--sidebar-bg);
        padding: 110px 18px 36px 24px; /* top padding for avatar overlap */
        border-right: 1px solid var(--line);
        box-sizing: border-box;
        position: relative;
        z-index: 2;

        /* ensure long words wrap in the narrow left column */
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
      }
      .avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 8px solid var(--white);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        position: absolute;
        left: 20px;
        top: -75px;
        background: var(--white);
        z-index: 10;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .left-col h1 {
        font-size: 18px;
        margin: 12px 0 4px;
        color: var(--accent);
        font-weight: 700;
      }
      .left-col .role-small {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 10px;
      }

      /* Section titles */
      .section-title {
        margin-top: 22px;
        margin-bottom: 8px;
        font-weight: 800;
        color: var(--accent);
        letter-spacing: 0.06em;
        font-size: 15px;
      }

      /* Contact list */
      .contact-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .contact-list li {
        padding: 12px 0;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
        font-size: 14px;
        color: #2e3336;
      }
      .contact-list li strong {
        display: block;
        font-weight: 700;
        margin-bottom: 6px;
        color: var(--accent);
        font-size: 13px;
      }
      /* make contact values wrap safely */
      .contact-list li div,
      .contact-list li div a {
        display: block;
        max-width: 100%;
        white-space: normal !important;
        overflow-wrap: anywhere !important;
        word-break: break-word !important;
        line-height: 1.4;
      }

      /* Right column */
      .right-col {
        flex: 1;
        padding: 28px 48px; /* adjusted to match target screenshot spacing */
        background: var(--white);
        box-sizing: border-box;

        /* ensure long words wrap and do not overflow the right column */
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;

        /* main text color matching screenshot */
        color: #333;
      }

      /* Blocks and headings */
      .block {
        margin-bottom: 28px;
      }
      .block h2 {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0 0 12px;
        font-size: 18px;
        color: #2b3344; /* slightly navy heading (matches screenshot) */
        font-weight: 800;
      }

      /* Profile text */
      .profile-text {
        color: #333;
        line-height: 1.7;
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
      }

      /* Timeline / Experience */
      .tl-item {
        position: relative;
        padding: 10px 0 14px;
      }
      .timeline {
        position: relative;
        padding-left: 0;
        margin-left: 0;
      }
      .timeline::before {
        display: none;
      }
      .tl-item::before {
        display: none;
      }

      .tl-title {
        font-weight: 700;
        margin: 0 0 6px;
        font-size: 16px;
        color: #2b3344;
      }
      .tl-meta {
        float: right;
        color: var(--muted);
        font-weight: 700;
        font-size: 13px;
      }
      .tl-company {
        color: var(--muted);
        margin-bottom: 8px;
      }
      .tl-desc {
        color: #333;
        line-height: 1.6;
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
      }

      /* Education */
      .edu-item {
        margin-bottom: 12px;
      }
      .edu-item .meta {
        color: var(--muted);
        font-size: 13px;
      }
      .edu-date {
        float: right;
        color: var(--muted);
        font-weight: 700;
        font-size: 16px;
        letter-spacing: 0.3px;
      }
      .edu-item {
        margin-bottom: 18px;
      }

      /* Skills & lists — restore bullets and color */
      .skills-list {
        list-style: disc !important;
        padding-left: 20px !important;
        margin: 6px 0;
      }
      .skills-list li {
        margin: 6px 0;
        font-size: 14px;
        color: #333;
      }
      .skills-list li strong {
        display: inline-block;
        margin-right: 8px;
        color: var(--accent);
        font-weight: 800;
        font-size: 13px;
      }

      /* Left column specific skills list tweak (to match screenshot) */
      .left-col .skills-list {
        list-style: disc !important;
        padding-left: 22px !important;
        margin-top: 8px;
      }
      .left-col .skills-list li {
        color: #333;
        font-size: 14px;
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
      }

      /* Utility pills & list item styling */
      .pill {
        display: inline-block;
        margin: 6px 6px 6px 0;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(43, 51, 68, 0.06);
        font-size: 13px;
        color: var(--accent);
        text-decoration: none;
        line-height: 1;
      }
      .list-item {
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.04);
      }
      .list-item-title {
        font-weight: 700;
        margin: 0 0 6px;
        font-size: 15px;
        color: var(--accent);
      }

      /* Additional & declaration text */
      .right-col .block div {
        color: #333;
        line-height: 1.6;
      }
      .right-col .block h2 {
        margin-bottom: 8px;
      }

      /* Responsive adjustments */
      @media (max-width: 900px) {
        .resume-header .name {
          font-size: 28px;
        }
        .left-col {
          width: 100%;
          padding: 24px;
          order: 0;
        }
        .avatar {
          position: relative;
          left: calc(50% - 75px);
          top: -65px;
          margin-bottom: 8px;
        }
        .resume-body {
          flex-direction: column;
        }
        .right-col {
          padding: 20px;
        }
        .pill {
          margin: 6px 4px 6px 0;
          padding: 5px 8px;
          font-size: 12px;
        }
      }

      /* Print/PDF rules (no layout changes) */
      .tl-item,
      .timeline,
      .edu-item,
      .block {
        page-break-inside: avoid;
        break-inside: avoid;
        -webkit-column-break-inside: avoid;
        -moz-column-break-inside: avoid;
      }
      @page {
        size: A4;
        margin: 0;
      }
      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        .controls,
        #pdfBtn,
        #txtBtn {
          display: none !important;
        }
        .tl-item,
        .timeline,
        .edu-item,
        .block {
          break-inside: avoid !important;
          page-break-inside: avoid !important;
        }
        .resume {
          background-clip: padding-box !important;
          overflow: visible !important;
        }
        .pill {
          background: transparent;
          border: 1px solid #eee;
          color: #111;
        }
        .contact-list li {
          border-bottom: 1px dashed #eee;
        }
        .list-item {
          border-bottom: 1px dashed #eee;
          page-break-inside: avoid;
        }
      }

      /* Safety: hard-limits to avoid overflow in extreme cases */
      .resume,
      .right-col,
      .left-col {
        max-width: 100%;
        box-sizing: border-box;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="controls">
        <button id="pdfBtn">Download PDF (exact)</button>
        <button id="txtBtn">Download TXT</button>
      </div>

      <div id="resumeRoot" class="resume" aria-live="polite"></div>
    </div>

    <script>
      // ---------- Config & helpers (unchanged from robust version) ----------
      const DEFAULT_PHOTO =
        "/mnt/data/6e80851d-4cca-4dc0-bf0c-7ac1293103ca.png";
      const LOCAL_STORAGE_KEY = "resumeData";

      function log(...args) {
        console.log("[resume-pdf]", ...args);
      }
      function safe(s = "") {
        return String(s || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[c])
        );
      }
      function normalizeUrl(u) {
        if (!u) return "";
        u = String(u).trim();
        if (
          u.startsWith("/") ||
          u.startsWith("http://") ||
          u.startsWith("https://") ||
          u.startsWith("data:") ||
          u.startsWith("blob:")
        )
          return u;
        return "https://" + u;
      }
      function formatMonthYear(val) {
        if (!val) return "";
        val = String(val).trim();
        // already "Aug 2020"
        if (/^[A-Za-z]{3,}\s+\d{4}$/.test(val)) return val;
        // YYYY-MM
        const m = val.match(/^(\d{4})-(\d{2})$/);
        if (m) {
          const y = m[1];
          const mm = parseInt(m[2], 10);
          const months = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          return (months[mm - 1] || "") + " " + y;
        }
        // fallback: return as-is
        return val;
      }

      // find element by selector + contained text (replaces :contains)
      function querySelectorByText(selector, text, { exact = false } = {}) {
        try {
          const nodes = Array.from(document.querySelectorAll(selector || ""));
          if (exact)
            return (
              nodes.find((n) => (n.textContent || "").trim() === text) || null
            );
          return (
            nodes.find((n) => (n.textContent || "").includes(text)) || null
          );
        } catch (e) {
          console.error("querySelectorByText failed", e, selector, text);
          return null;
        }
      }

      // convert image to dataURL (best-effort)
      async function imageUrlToDataUrl(url) {
        try {
          if (!url) return "";
          if (url.startsWith("data:")) return url;
          if (location.protocol === "file:") {
            log(
              "Running from file:// — skipping image fetch to avoid CORS issues"
            );
            return url;
          }
          const resp = await fetch(url, { mode: "cors" });
          if (!resp.ok) throw new Error("image fetch failed: " + resp.status);
          const blob = await resp.blob();
          return await new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.onerror = () => rej(new Error("FileReader failed"));
            reader.readAsDataURL(blob);
          });
        } catch (err) {
          log("imageUrlToDataUrl failed for", url, err);
          return url;
        }
      }

      function loadScript(src, globalCheckFn, timeoutMs = 12000) {
        return new Promise((res, rej) => {
          try {
            if (globalCheckFn && globalCheckFn()) return res();
          } catch (e) {}
          const s = document.createElement("script");
          s.src = src;
          s.async = true;
          let done = false;
          const to = setTimeout(() => {
            if (done) return;
            done = true;
            rej(new Error("Loading script timed out: " + src));
          }, timeoutMs);
          s.onload = () => {
            if (done) return;
            done = true;
            clearTimeout(to);
            setTimeout(res, 30);
          };
          s.onerror = () => {
            if (done) return;
            done = true;
            clearTimeout(to);
            rej(new Error("Failed to load " + src));
          };
          document.head.appendChild(s);
        });
      }

      async function ensureHtml2Pdf() {
        if (
          window.html2pdf &&
          (window.html2canvas || window.html2pdf.html2canvas) &&
          (window.jspdf ||
            window.jsPDF ||
            (window.html2pdf && window.html2pdf.jsPDF))
        ) {
          if (
            !window.html2canvas &&
            window.html2pdf &&
            window.html2pdf.html2canvas
          )
            window.html2canvas = window.html2pdf.html2canvas;
          if (!window.jsPDF && window.jspdf && window.jspdf.jsPDF)
            window.jsPDF = window.jspdf.jsPDF;
          if (!window.jsPDF && window.html2pdf && window.html2pdf.jsPDF)
            window.jsPDF = window.html2pdf.jsPDF;
          return window.html2pdf;
        }
        // try load libs from CDN (gracefully)
        await loadScript(
          "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",
          () => !!window.html2canvas
        ).catch((e) => log("html2canvas load warning:", e));
        await loadScript(
          "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
          () => !!(window.jspdf && window.jspdf.jsPDF) || !!window.jsPDF
        ).catch((e) => log("jsPDF load warning:", e));
        await loadScript(
          "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js",
          () => !!window.html2pdf
        ).catch((e) => log("html2pdf load warning:", e));
        if (
          !window.html2canvas &&
          window.html2pdf &&
          window.html2pdf.html2canvas
        )
          window.html2canvas = window.html2pdf.html2canvas;
        if (!window.jsPDF) {
          if (window.jspdf && window.jspdf.jsPDF)
            window.jsPDF = window.jspdf.jsPDF;
          if (window.html2pdf && window.html2pdf.jsPDF)
            window.jsPDF = window.html2pdf.jsPDF;
        }
        if (!window.html2pdf) throw new Error("html2pdf failed to load");
        return window.html2pdf;
      }

      // ---------------- render resume preview ----------------
      // ---------------- render resume preview (REPLACEMENT: only render non-empty fields) ----------------
      (function renderPreview() {
        const data = JSON.parse(
          localStorage.getItem(LOCAL_STORAGE_KEY) || "{}"
        );
        const pi = data.personalInfo || {};
        const pl = data.publicLinks || {};
        // If no photo → keep empty (do not show avatar)
        const photo =
          pi.profilePhoto && pi.profilePhoto.trim()
            ? pi.profilePhoto.trim()
            : "";

        // helper: return empty string when nothing to show
        function emptyNodeHtml() {
          return ""; // <-- important: show nothing when empty
        }

        // Contact builder: returns '' if no contact items
        function buildContact(pi, pl) {
          const items = [];
          if (pi && pi.email)
            items.push(
              `<li><strong>EMAIL</strong><div>${safe(pi.email)}</div></li>`
            );
          if (pi && pi.phone)
            items.push(
              `<li><strong>PHONE</strong><div>${safe(pi.phone)}</div></li>`
            );
          if (pi && pi.location)
            items.push(
              `<li><strong>ADDRESS</strong><div>${safe(pi.location)}</div></li>`
            );

          ["website", "portfolio", "github", "linkedin"].forEach((k) => {
            if (pl && pl[k]) {
              const url = normalizeUrl(pl[k]);
              items.push(
                `<li><strong>${safe(
                  k.toUpperCase()
                )}</strong><div><a href="${url}" target="_blank" rel="noopener">${safe(
                  pl[k]
                )}</a></div></li>`
              );
            }
          });

          if (Array.isArray(pl && pl.custom) && pl.custom.length) {
            pl.custom.forEach((c) => {
              if (c && (c.name || c.url)) {
                const label = safe(c.name || c.title || "Link");
                const url = normalizeUrl(c.url || c.href || "");
                items.push(
                  `<li><strong>${label}</strong><div>${
                    url
                      ? `<a href="${url}" target="_blank" rel="noopener">${safe(
                          c.url
                        )}</a>`
                      : safe(c.name)
                  }</div></li>`
                );
              }
            });
          }

          if (!items.length) return ""; // nothing to show
          return '<ul class="contact-list">' + items.join("") + "</ul>";
        }

        // generic list renderer — returns '' when empty
        function listify(arr, opts = {}) {
          if (!Array.isArray(arr) || !arr.length) return ""; // nothing
          return (
            `<ul class="${opts.cls || "skills-list"}">` +
            arr
              .map((item) => {
                if (typeof item === "string") return `<li>${safe(item)}</li>`;
                if (opts.type === "languages") {
                  const name = safe(item.name || item.language || "");
                  const lvl = item.level
                    ? ` <span class="muted">(${safe(item.level)})</span>`
                    : "";
                  return `<li>${name}${lvl}</li>`;
                }
                if (opts.type === "skills") {
                  const name = `<strong>${safe(
                    item.name || item.skill || ""
                  )}</strong>`;
                  const cat = item.category
                    ? ` <span class="muted"><br>(${safe(item.category)})</span>`
                    : "";
                  const lvl = item.level
                    ? ` <span class="muted"> <br>${safe(item.level)}</span>`
                    : "";
                  return `<li>${name}${cat}${lvl}</li>`;
                }
                return `<li>${safe(
                  item.name || item.hobby || item.title || ""
                )}</li>`;
              })
              .join("") +
            `</ul>`
          );
        }

        // Experience / project / education builders: return '' when empty
        function buildExperience(arr) {
          if (!Array.isArray(arr) || !arr.length) return "";
          return arr
            .map((e) => {
              const title = safe(e.jobTitle || e.title || "");
              const meta = `${formatMonthYear(e.startDate)}${
                e.current
                  ? " - Present"
                  : e.endDate
                  ? " - " + formatMonthYear(e.endDate)
                  : ""
              }`;

              const company = safe(e.company || e.employer || "");
              const desc = e.description
                ? `<div class="tl-desc">${safe(e.description).replace(
                    /\n/g,
                    "<br>"
                  )}</div>`
                : "";
              return `<div class="tl-item"><p class="tl-title">${title} <span class="tl-meta">${meta}</span></p><div class="tl-company">${company}</div>${desc}</div>`;
            })
            .join("");
        }

        function buildEducation(arr) {
          if (!Array.isArray(arr) || !arr.length) return "";
          return arr
            .map((e) => {
              const degree = safe(e.degree || "");
              const inst = safe(e.institution || e.school || "");
              const meta = `${formatMonthYear(e.startDate)}${
                e.current
                  ? " - Present"
                  : e.endDate
                  ? " - " + formatMonthYear(e.endDate)
                  : ""
              }`;

              const desc = e.description
                ? `<div style="margin-top:6px">${safe(e.description).replace(
                    /\n/g,
                    "<br>"
                  )}</div>`
                : "";
              const score = e.score
                ? `<div class="muted">${safe(e.scoreType || "")}: ${safe(
                    e.score
                  )}</div>`
                : "";
              return `<div class="edu-item"><p style="margin:0;font-weight:700">${degree}</p><div class="meta">${inst}<span class="edu-date">${meta}</span></div>${desc}${score}</div>`;
            })
            .join("");
        }

        function buildProjects(arr) {
          if (!Array.isArray(arr) || !arr.length) return "";
          return arr
            .map((p) => {
              const title = safe(p.name || p.title || "");
              const meta = `${formatMonthYear(p.startDate)}${
                p.current
                  ? " - Present"
                  : p.endDate
                  ? " - " + formatMonthYear(p.endDate)
                  : ""
              }`;

              const desc = p.description
                ? `<div class="tl-desc">${safe(p.description).replace(
                    /\n/g,
                    "<br>"
                  )}</div>`
                : "";
              const link = p.projectUrl
                ? `<div><a href="${normalizeUrl(
                    p.projectUrl
                  )}" target="_blank" rel="noopener">${safe(
                    p.projectUrl
                  )}</a></div>`
                : "";
              return `<div class="tl-item"><p class="tl-title">${title} <span class="tl-meta">${meta}</span></p>${desc}${link}</div>`;
            })
            .join("");
        }

        function buildCertifications(arr) {
          if (!Array.isArray(arr) || !arr.length) return "";
          return arr
            .map((c) => {
              const title = safe(c.name || "");
              const meta = `${safe(c.issuer || c.authority || "")}${
                c.date ? " • " + safe(c.date) : ""
              }`;
              const desc = c.description
                ? `<div class="tl-desc">${safe(c.description).replace(
                    /\n/g,
                    "<br>"
                  )}</div>`
                : "";
              const link = c.url
                ? `<div><a href="${normalizeUrl(
                    c.url
                  )}" target="_blank" rel="noopener">${safe(c.url)}</a></div>`
                : "";
              return `<div class="tl-item"><p class="tl-title">${title} <span class="tl-meta">${meta}</span></p>${desc}${link}</div>`;
            })
            .join("");
        }

        function buildInternships(arr) {
          if (!Array.isArray(arr) || !arr.length) return "";
          return arr
            .map((it) => {
              const title = safe(it.name || "");
              const org = safe(it.organization || it.company || "");
              const meta = `${formatMonthYear(it.startDate)}${
                it.current
                  ? " - Present"
                  : it.endDate
                  ? " - " + formatMonthYear(it.endDate)
                  : ""
              }`;

              const desc = it.description
                ? `<div class="tl-desc">${safe(it.description).replace(
                    /\n/g,
                    "<br>"
                  )}</div>`
                : "";
              return `<div class="tl-item"><p class="tl-title">${title} <span class="tl-meta">${meta}</span></p><div class="tl-company">${org}</div>${desc}</div>`;
            })
            .join("");
        }

        function buildAchievements(arr) {
          if (!Array.isArray(arr) || !arr.length) return "";
          return (
            `<ul class="skills-list">` +
            arr
              .map((a) => {
                if (!a) return "";
                if (typeof a === "string") return `<li>${safe(a)}</li>`;
                if (a.achievement) return `<li>${safe(a.achievement)}</li>`;
                if (a.text) return `<li>${safe(a.text)}</li>`;
                return `<li>${safe(a.title || a.name || "")}</li>`;
              })
              .join("") +
            `</ul>`
          );
        }

        // Compose final HTML: include a section only when it has content
        const root = document.getElementById("resumeRoot");
        const contactHtml = buildContact(pi, pl);
        const skillsHtml = listify(data.skills, {
          type: "skills",
          cls: "skills-list",
        });
        const languagesHtml = listify(data.languages, {
          type: "languages",
          cls: "skills-list",
        });
        const hobbiesHtml = listify(data.hobbies, { cls: "skills-list" });

        const profileHtml = pi.summary
          ? `<div class="block"><h2>PROFILE</h2><div class="profile-text">${safe(
              pi.summary
            ).replace(/\n/g, "<br>")}</div></div>`
          : "";

        const experienceHtml = buildExperience(data.experience);
        const experienceBlock = experienceHtml
          ? `<div class="block"><h2>WORK EXPERIENCE</h2><div class="timeline">${experienceHtml}</div></div>`
          : "";

        const educationHtml = buildEducation(data.education);
        const educationBlock = educationHtml
          ? `<div class="block"><h2>EDUCATION</h2>${educationHtml}</div>`
          : "";

        const internshipsHtml = buildInternships(data.internships);
        const internshipsBlock = internshipsHtml
          ? `<div class="block"><h2>INTERNSHIPS</h2>${internshipsHtml}</div>`
          : "";

        const projectsHtml = buildProjects(data.projects);
        const projectsBlock = projectsHtml
          ? `<div class="block"><h2>PROJECTS</h2>${projectsHtml}</div>`
          : "";

        const certsHtml = buildCertifications(data.certifications);
        const certsBlock = certsHtml
          ? `<div class="block"><h2>CERTIFICATIONS</h2>${certsHtml}</div>`
          : "";

        const achievementsHtml = buildAchievements(data.achievements);
        const achievementsBlock = achievementsHtml
          ? `<div class="block"><h2>ACHIEVEMENTS</h2>${achievementsHtml}</div>`
          : "";

        const additionalHtml = data.additionalInfo
          ? `<div class="block"><h2>ADDITIONAL INFORMATION</h2><div>${safe(
              data.additionalInfo
            ).replace(/\n/g, "<br>")}</div></div>`
          : "";

        const declarationHtml = data.declaration
          ? `<div class="block"><h2>DECLARATION</h2><div id="preview-declaration">${safe(
              data.declaration
            ).replace(/\n/g, "<br>")}</div></div>`
          : "";

        // Left column: only render section headers when their content exists
        const leftSections = [];
        if (contactHtml)
          leftSections.push(
            `<div class="section-title">CONTACT</div>${contactHtml}`
          );
        if (skillsHtml)
          leftSections.push(
            `<div class="section-title">SKILLS</div>${skillsHtml}`
          );
        if (languagesHtml)
          leftSections.push(
            `<div class="section-title">LANGUAGES</div>${languagesHtml}`
          );
        if (hobbiesHtml)
          leftSections.push(
            `<div class="section-title">HOBBIES</div>${hobbiesHtml}`
          );

        root.innerHTML = `
    <div class="resume-header">
      <div class="name">${safe(pi.fullName || "PHANINDRA")}</div>
      <div class="subtitle">${safe(pi.jobTitle || pi.title || "")}</div>
    </div>

    <div class="resume-body">
     <!-- left column: avatar only if photo exists -->
<div class="left-col" ${photo ? "" : 'style="padding-top:24px"'} >
  
  ${
    photo
      ? `<div class="avatar" aria-hidden="true">
         <img id="avatarImg" src="${safe(photo)}" alt="Photo">
       </div>`
      : ""
  }

  ${leftSections.join("")}
</div>


      <div class="right-col">
        ${profileHtml}
        ${experienceBlock}
        ${educationBlock}
        ${internshipsBlock}
        ${projectsBlock}
        ${certsBlock}
        ${achievementsBlock}
        ${additionalHtml}
        ${declarationHtml}
      </div>
    </div>
  `;
      })();

      // ---------------- PDF creation (unchanged logic) ----------------
      document.getElementById("pdfBtn").addEventListener("click", async () => {
        try {
          log("PDF (screen-capture) start...");
          await ensureHtml2Pdf();

          const html2canvasFn =
            window.html2canvas ||
            (window.html2pdf && window.html2pdf.html2canvas);
          const jsPDFClass =
            window.jsPDF ||
            (window.jspdf && window.jspdf.jsPDF) ||
            (window.html2pdf && window.html2pdf.jsPDF);
          if (!html2canvasFn) throw new Error("html2canvas not available.");
          if (!jsPDFClass) throw new Error("jsPDF not available.");

          const avatarImg = document.getElementById("avatarImg");
          if (avatarImg && avatarImg.src) {
            try {
              const dataUrl = await imageUrlToDataUrl(avatarImg.src);
              avatarImg.src = dataUrl;
            } catch (e) {
              log("avatar -> dataUrl conversion failed:", e);
            }
          }

          const rootEl = document.getElementById("resumeRoot");
          if (!rootEl) throw new Error("resumeRoot element not found.");
          window.scrollTo(0, 0);

          const DPR = Math.min(window.devicePixelRatio || 1, 3);
          const canvas = await html2canvasFn(rootEl, {
            scale: DPR,
            useCORS: true,
            allowTaint: false,
            logging: false,
            backgroundColor:
              window.getComputedStyle(rootEl).backgroundColor || "#ffffff",
          });

          const A4_WIDTH_MM = 210,
            A4_HEIGHT_MM = 297;
          const pxPerMm = (96 * DPR) / 25.4;
          const a4Wpx = Math.round(A4_WIDTH_MM * pxPerMm);
          const a4Hpx = Math.round(A4_HEIGHT_MM * pxPerMm);

          const capturedW = canvas.width,
            capturedH = canvas.height;
          const widthScale = Math.min(1, a4Wpx / capturedW);
          const targetWpx = Math.round(capturedW * widthScale);
          const targetHpx = Math.round(capturedH * widthScale);

          let finalCanvas = canvas;
          if (widthScale !== 1) {
            const tmp = document.createElement("canvas");
            tmp.width = targetWpx;
            tmp.height = targetHpx;
            const ctx = tmp.getContext("2d");
            ctx.imageSmoothingQuality = "high";
            ctx.drawImage(
              canvas,
              0,
              0,
              canvas.width,
              canvas.height,
              0,
              0,
              tmp.width,
              tmp.height
            );
            finalCanvas = tmp;
          }

          const TOP_MARGIN_MM = 12,
            BOTTOM_MARGIN_MM = 12;
          const topMarginPx = Math.round(TOP_MARGIN_MM * pxPerMm);
          const bottomMarginPx = Math.round(BOTTOM_MARGIN_MM * pxPerMm);
          const availableHeightPx = a4Hpx - topMarginPx - bottomMarginPx;
          const firstPageBottomMarginPx = Math.round(
            BOTTOM_MARGIN_MM * pxPerMm
          );
          const firstPageHeightPx = a4Hpx - firstPageBottomMarginPx;
          const subsequentPageHeightPx = availableHeightPx;

          const actualPages = Math.max(
            1,
            Math.ceil(
              Math.max(0, finalCanvas.height - firstPageHeightPx) /
                subsequentPageHeightPx
            ) + (finalCanvas.height > 0 ? 1 : 0)
          );

          const pageImages = [];
          const sidebarCssPx = 230;
          const sidebarPx = Math.round(sidebarCssPx * DPR * widthScale);

          for (let p = 0; p < actualPages; p++) {
            const sliceStartY =
              p === 0
                ? 0
                : firstPageHeightPx + (p - 1) * subsequentPageHeightPx;
            const srcH = Math.min(
              p === 0 ? firstPageHeightPx : subsequentPageHeightPx,
              Math.max(0, finalCanvas.height - sliceStartY)
            );
            const pageCanvas = document.createElement("canvas");
            pageCanvas.width = a4Wpx;
            pageCanvas.height = a4Hpx;
            const ctx = pageCanvas.getContext("2d");
            const sidebarColor = (
              getComputedStyle(document.documentElement).getPropertyValue(
                "--sidebar-bg"
              ) || "#e9e9eb"
            ).trim();
            ctx.fillStyle = sidebarColor;
            ctx.fillRect(0, 0, sidebarPx, a4Hpx);
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(sidebarPx, 0, a4Wpx - sidebarPx, a4Hpx);
            const drawOffsetY = p === 0 ? 0 : topMarginPx;
            const destW = a4Wpx;
            const destH = Math.round(srcH * (destW / finalCanvas.width));
            const destX = 0;
            const destY = drawOffsetY;
            if (srcH > 0 && destH > 0)
              ctx.drawImage(
                finalCanvas,
                0,
                sliceStartY,
                finalCanvas.width,
                srcH,
                destX,
                destY,
                destW,
                destH
              );
            pageImages.push(pageCanvas.toDataURL("image/jpeg", 1.0));
          }

          const doc = new jsPDFClass({
            unit: "mm",
            format: "a4",
            orientation: "portrait",
          });
          for (let p = 0; p < pageImages.length; p++) {
            if (p > 0) doc.addPage();
            doc.addImage(
              pageImages[p],
              "JPEG",
              0,
              0,
              A4_WIDTH_MM,
              A4_HEIGHT_MM,
              undefined,
              "NONE"
            );
          }

          // add links mapping
          const anchors = Array.from(rootEl.querySelectorAll("a[href]")).map(
            (a) => {
              const href = a.href;
              const r = a.getBoundingClientRect();
              const rr = rootEl.getBoundingClientRect();
              return {
                href,
                leftCss: r.left - rr.left,
                topCss: r.top - rr.top,
                widthCss: r.width,
                heightCss: r.height,
              };
            }
          );
          function cssPxToMm(cssPx) {
            const canvasPx = cssPx * DPR * widthScale;
            return canvasPx / pxPerMm;
          }
          const FIRST_PAGE_HEIGHT_MM = firstPageHeightPx / pxPerMm;
          const SUBSEQ_PAGE_HEIGHT_MM = subsequentPageHeightPx / pxPerMm;

          anchors.forEach((a) => {
            if (!a.href) return;
            const leftMm = cssPxToMm(a.leftCss);
            const topMm = cssPxToMm(a.topCss);
            const wMm = cssPxToMm(a.widthCss);
            const hMm = cssPxToMm(a.heightCss);
            function mmToPage(mmY) {
              if (mmY < FIRST_PAGE_HEIGHT_MM) return 0;
              return (
                1 +
                Math.floor((mmY - FIRST_PAGE_HEIGHT_MM) / SUBSEQ_PAGE_HEIGHT_MM)
              );
            }
            const startPage = mmToPage(topMm);
            const endPage = mmToPage(topMm + hMm - 1e-6);
            for (let page = startPage; page <= endPage; page++) {
              if (page < 0 || page >= pageImages.length) continue;
              const pageGlobalTopMm =
                page === 0
                  ? 0
                  : FIRST_PAGE_HEIGHT_MM + (page - 1) * SUBSEQ_PAGE_HEIGHT_MM;
              const segTopGlobal = Math.max(topMm, pageGlobalTopMm);
              const segBottomGlobal = Math.min(
                topMm + hMm,
                pageGlobalTopMm + SUBSEQ_PAGE_HEIGHT_MM
              );
              const segHeightMm = segBottomGlobal - segTopGlobal;
              if (segHeightMm <= 0) continue;
              let localTopMm =
                page === 0
                  ? segTopGlobal
                  : segTopGlobal - pageGlobalTopMm + TOP_MARGIN_MM;
              const safeLeft = Math.max(0, leftMm);
              const safeTop = Math.max(0, localTopMm);
              const safeWidth = Math.max(0.1, wMm);
              const safeHeight = Math.max(0.1, segHeightMm);
              doc.setPage(page + 1);
              doc.link(safeLeft, safeTop, safeWidth, safeHeight, {
                url: a.href,
              });
            }
          });

          doc.save("resume.pdf");
          log("PDF saved.");
        } catch (err) {
          console.error("PDF error:", err);
          alert("PDF generation failed — check console for details.");
        }
      });

      // TXT download (unchanged)
      document.getElementById("txtBtn").addEventListener("click", () => {
        const txt = document.getElementById("resumeRoot").innerText;
        const blob = new Blob([txt], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "resume.txt";
        a.click();
      });
    </script>
  </body>
</html>
